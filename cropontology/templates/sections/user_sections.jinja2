{% extends 'page.jinja2' %}
{% import 'macros/form.jinja2' as form %}

{% block css %}
    {{ super() }}
    {% cssresource request,'main_library','sweetalert' %}
    {% cssresource request,'main_library','select_users' %}
     <style>
        @media (max-width: 767px) {
            .action-buttons {
                margin-top: 10px;
            }
        }
    </style>
{% endblock css %}

{% block breadcrums %}
    {% include 'sections/snippets/breadcrums_users.jinja2' %}
{% endblock breadcrums %}

{% block main_container %}
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <h2>{{ _('Search for a manager') }}</h2>
                    <small>{{ _('You can search by username, full name or email address') }}</small>
                    <div class="row">
                        <div class="col-md-9">
                            <select name="user" id="user" style="width: 100%; !important;" class="js-example-data-ajax form-control"></select>
                        </div>
                        <div class="col-md-3">
                            <button id="add_manager" class="btn btn-block btn-success"> <i class="fas fa-user-plus"></i> {{ _('Add manager') }}</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h4>{{ _('Current managers') }}</h4>
                </div>
                <div class="card-body table-responsive p-0" style="height: 300px;">
                    {{ form.display_errors(errors) }}
                    <table class="table table-head-fixed text-nowrap">
                        <thead>
                        <tr>
                            <th>{{ _('Name') }}</th>
                            <th>{{ _('Date added') }}</th>
                            <th>{{ _('Actions') }}</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for user in section_users %}
                            {% include 'sections/snippets/user_item.jinja2' %}
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
{% endblock main_container %}

{% block scripts %}
    {{ super() }}
    {% jsresource request,'main_library','sweetalert' %}
    {% jsresource request,'main_library','select_users' %}
    <script>
        $(document).ready(function() {
            $('.remove_user').click(function () {
                var action_url = $( this ).attr('urn');
                var user_name = $( this ).attr('data-user-name');
                swal({
                        title: "{{ _('Are you sure?') }}",
                        text: "{{ _('You will remove the manager: ') }}" + user_name,
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#DD6B55",
                        confirmButtonText: "{{ _('Yes, delete it!') }}",
                        cancelButtonText: "{{ _('Oops, cancel!') }}",
                        closeOnConfirm: true,
                        closeOnCancel: true },
                    function (isConfirm) {
                        if (isConfirm) {
                            var form = document.createElement('form');
                            form.setAttribute('method', 'post');
                            form.setAttribute('action', action_url);
                            form.style.display = 'hidden';

                            var i = document.createElement("input"); //input element, text
                            i.setAttribute('type',"text");
                            i.setAttribute('name',"csrf_token");
                            i.setAttribute('value','{{ request.session.get_csrf_token() }}');
                            form.appendChild(i);

                            document.body.appendChild(form);
                            form.submit();
                        }
                    });
            });
        })
    </script>
    <script>
        $(document).ready(function() {

            $('#add_manager').click(function () {
                let selected_user = $('#user').find(":selected").val();
                if (selected_user)
                {
                    let form = document.createElement('form');
                    form.setAttribute('method', 'post');
                    form.setAttribute('action', '{{ request.url }}');
                    form.style.display = 'hidden';

                    let i = document.createElement("input"); //input element, text
                    i.setAttribute('type',"text");
                    i.setAttribute('name',"csrf_token");
                    i.setAttribute('value','{{ request.session.get_csrf_token() }}');
                    form.appendChild(i);

                    let user = document.createElement("input"); //input element, text
                    user.setAttribute('type',"text");
                    user.setAttribute('name',"user");
                    user.setAttribute('value',selected_user);
                    form.appendChild(user);

                    document.body.appendChild(form);
                    form.submit();
                }

            });

            function formatUser (user) {
                if (!user.id) {
                    return user.text;
                }
                let baseUrl = "{{ request.route_url('gravatar') }}";
                let $state = $(
                    '<span><img src="' + baseUrl + '?name=' + user.text + '&size=45" class="img-flag" /> ' + user.text + '</span>'
                );
                return $state;
            }

            $(".js-example-data-ajax").select2({
                templateResult: formatUser,
                ajax: {
                    url: "{{ request.route_url('api_select2_users') }}",
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            q: params.term, // search term
                            page: params.page,
                            include_me: "True",
                        };
                    },
                    processResults: function (data, params) {
                        params.page = params.page || 1;
                        return {
                            results: data.results,
                            pagination: {
                                more: (params.page * 10) < data.total
                            }
                        };
                    },
                    cache: true
                }
            });

        });
    </script>
{% endblock scripts %}